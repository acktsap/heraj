<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JsonResolver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">heraj</a> &gt; <a href="index.source.html" class="el_package">hera.spec.resolver</a> &gt; <span class="el_source">JsonResolver.java</span></div><h1>JsonResolver.java</h1><pre class="source lang-java linenums">/*
 * @copyright defined in LICENSE.txt
 */

package hera.spec.resolver;

import static org.slf4j.LoggerFactory.getLogger;

import hera.annotation.ApiAudience;
import hera.annotation.ApiStability;
import hera.api.model.BigNumber;
import hera.spec.AergoSpec;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import org.slf4j.Logger;

/**
 * &lt;p&gt;
 * Custom json formatter for java object to remove dependency to json handling library. It converts
 * following java types into json type.
 * &lt;/p&gt;
 * 
 * &lt;pre&gt;
 *   - {@link List} -&amp;gt; json array
 *   - {@link Map} -&amp;gt; json object
 *   - null -&amp;gt; json null
 *   - {@link String} -&amp;gt; json string
 *   - {@link Number} -&amp;gt; json number
 *   - {@link Boolean} -&amp;gt; json boolean
 * &lt;/pre&gt;
 * 
 * &lt;p&gt;
 * It also convert aergo-specific model {@link BigNumber} like
 * &lt;/p&gt;
 * 
 * &lt;pre&gt;
 *   BigNumber with value &quot;1000&quot; -&amp;gt; { {@link AergoSpec#BIGNUM_JSON_KEY}: &quot;1000&quot; }
 * &lt;/pre&gt;
 * 
 *
 * @author taeiklim
 *
 */
@ApiAudience.Private
@ApiStability.Unstable
<span class="nc" id="L47">public class JsonResolver {</span>

  /**
   * Lookup table used for determining which output characters in 7-bit ASCII range need to be
   * quoted. This is from jackson CharTypes class.
   */
  static final int[] sOutputEscapes128;

  static {
<span class="fc" id="L56">    int[] table = new int[128];</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">    for (int i = 0; i &lt; 32; ++i) {</span>
<span class="fc" id="L58">      table[i] = -1;</span>
    }
    /*
     * Others (and some within that range too) have explicit shorter sequences
     */
<span class="fc" id="L63">    table['&quot;'] = '&quot;';</span>
<span class="fc" id="L64">    table['\\'] = '\\';</span>
    // Escaping of slash is optional, so let's not add it
<span class="fc" id="L66">    table[0x08] = 'b';</span>
<span class="fc" id="L67">    table[0x09] = 't';</span>
<span class="fc" id="L68">    table[0x0C] = 'f';</span>
<span class="fc" id="L69">    table[0x0A] = 'n';</span>
<span class="fc" id="L70">    table[0x0D] = 'r';</span>
<span class="fc" id="L71">    sOutputEscapes128 = table;</span>
  }

  public static final String JSON_START = &quot;{ &quot;;
  public static final String JSON_END = &quot; }&quot;;
  public static final String JSON_ARRAY_START = &quot;[ &quot;;
  public static final String JSON_ARRAY_END = &quot; ]&quot;;
  public static final String JSON_NEXT = &quot;,&quot;;

<span class="fc" id="L80">  protected static final Logger logger = getLogger(JsonResolver.class);</span>



  /**
   * Convert java {@link List} into json array form.
   *
   * @param args an arguments in list
   * @return a json array in string form
   */
  public static String asJsonArray(final List&lt;Object&gt; args) {
<span class="fc" id="L91">    final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L92">    sb.append(JSON_ARRAY_START);</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">    for (int i = 0; i &lt; args.size(); ++i) {</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">      if (i != 0) {</span>
<span class="fc" id="L95">        sb.append(JSON_NEXT);</span>
      }
<span class="fc" id="L97">      final Object arg = args.get(i);</span>
<span class="fc" id="L98">      sb.append(toJsonValue(arg));</span>
    }
<span class="fc" id="L100">    sb.append(JSON_ARRAY_END);</span>
<span class="fc" id="L101">    return sb.toString();</span>
  }

  /**
   * Convert java {@link Map} into json object form.
   *
   * @param object an object in a java map form
   * @return a json object in string form
   */
  public static String asJsonObject(final Map&lt;String, Object&gt; object) {
<span class="fc" id="L111">    final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L112">    sb.append(JSON_START);</span>
<span class="fc" id="L113">    int index = 0;</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">    for (final Entry&lt;String, Object&gt; element : object.entrySet()) {</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">      if (index != 0) {</span>
<span class="fc" id="L116">        sb.append(JSON_NEXT);</span>
      }
<span class="fc" id="L118">      final String key = element.getKey();</span>
<span class="fc" id="L119">      final String value = toJsonValue(element.getValue());</span>
<span class="fc" id="L120">      sb.append(asJsonString(key) + &quot;:&quot; + value);</span>
<span class="fc" id="L121">      ++index;</span>
<span class="fc" id="L122">    }</span>
<span class="fc" id="L123">    sb.append(JSON_END);</span>
<span class="fc" id="L124">    return sb.toString();</span>
  }

  /**
   * Convert java type into corresponding json value.
   *
   * @param object a json value in a java type
   * @return a json value in string form
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public static String toJsonValue(final Object object) {
    String ret;
<span class="fc" id="L136">    logger.trace(&quot;Next json value: {}&quot;, object);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">    if (object instanceof List) {</span>
<span class="fc" id="L138">      ret = asJsonArray((List&lt;Object&gt;) object);</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">    } else if (object instanceof Map) {</span>
<span class="fc" id="L140">      ret = asJsonObject((Map&lt;String, Object&gt;) object);</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">    } else if (object instanceof String) {</span>
<span class="fc" id="L142">      ret = asJsonString((String) object);</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">    } else if (null == object) {</span>
<span class="fc" id="L144">      ret = asJsonNull();;</span>
<span class="pc bpc" id="L145" title="3 of 8 branches missed.">    } else if (object instanceof Integer</span>
        || object instanceof Long
        || object instanceof Float
        || object instanceof Double) {
<span class="fc" id="L149">      ret = asJsonNumber((Number) object);</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">    } else if (object instanceof Boolean) {</span>
<span class="fc" id="L151">      ret = asJsonBoolean((Boolean) object);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">    } else if (object instanceof BigNumber) {</span>
<span class="nc" id="L153">      ret = BigNumberResolver.toJsonForm((BigNumber) object);</span>
    } else {
<span class="nc" id="L155">      throw new IllegalArgumentException(&quot;Cannot convert argument type: &quot; + object.getClass()</span>
          + &quot; into aergo argument json format&quot;);
    }

<span class="fc" id="L159">    return ret;</span>
  }

  /**
   * Convert java null into json null.
   *
   * @return a json null
   */
  public static String asJsonNull() {
<span class="fc" id="L168">    return &quot;null&quot;;</span>
  }

  /**
   * Convert java {@link String} into json string.
   *
   * @param target a target in java string type
   * @return a json string
   */
  public static String asJsonString(final String target) {
<span class="fc" id="L178">    final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L179">    sb.append('&quot;');</span>
<span class="fc" id="L180">    appendQuoted(sb, target);</span>
<span class="fc" id="L181">    sb.append('&quot;');</span>
<span class="fc" id="L182">    return sb.toString();</span>
  }

  protected static void appendQuoted(StringBuilder sb, String content) {
<span class="fc" id="L186">    final int[] escCodes = sOutputEscapes128;</span>
<span class="fc" id="L187">    int escLen = escCodes.length;</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">    for (int i = 0, len = content.length(); i &lt; len; ++i) {</span>
<span class="fc" id="L189">      char c = content.charAt(i);</span>
<span class="pc bpc" id="L190" title="2 of 4 branches missed.">      if (c &gt;= escLen || escCodes[c] == 0) {</span>
<span class="fc" id="L191">        sb.append(c);</span>
      } else {
<span class="nc" id="L193">        sb.append('\\');</span>
<span class="nc" id="L194">        int escCode = escCodes[c];</span>
<span class="nc" id="L195">        sb.append((char) escCode);</span>
      }
    }
<span class="fc" id="L198">  }</span>

  /**
   * Convert java {@link Number} into json number.
   *
   * @param target a target in java number type
   * @return a json number
   */
  public static String asJsonNumber(final Number target) {
<span class="fc" id="L207">    return target.toString();</span>
  }

  /**
   * Convert java {@link Boolean} into json boolean.
   *
   * @param target a target in java boolean type
   * @return a json boolean
   */
  public static String asJsonBoolean(final Boolean target) {
<span class="fc" id="L217">    return target.toString();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>