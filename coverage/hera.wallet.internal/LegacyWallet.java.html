<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LegacyWallet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">heraj</a> &gt; <a href="index.source.html" class="el_package">hera.wallet.internal</a> &gt; <span class="el_source">LegacyWallet.java</span></div><h1>LegacyWallet.java</h1><pre class="source lang-java linenums">/*
 * @copyright defined in LICENSE.txt
 */

package hera.wallet.internal;

import static org.slf4j.LoggerFactory.getLogger;

import hera.api.model.Account;
import hera.api.model.AccountAddress;
import hera.api.model.AccountFactory;
import hera.api.model.AccountState;
import hera.api.model.AccountTotalVote;
import hera.api.model.Aer;
import hera.api.model.Authentication;
import hera.api.model.Block;
import hera.api.model.BlockHash;
import hera.api.model.BlockMetadata;
import hera.api.model.BlockchainStatus;
import hera.api.model.BytesValue;
import hera.api.model.ChainIdHash;
import hera.api.model.ChainInfo;
import hera.api.model.ChainStats;
import hera.api.model.ContractAddress;
import hera.api.model.ContractDefinition;
import hera.api.model.ContractInterface;
import hera.api.model.ContractInvocation;
import hera.api.model.ContractResult;
import hera.api.model.ContractTxHash;
import hera.api.model.ContractTxReceipt;
import hera.api.model.ElectedCandidate;
import hera.api.model.Event;
import hera.api.model.EventFilter;
import hera.api.model.Fee;
import hera.api.model.Identity;
import hera.api.model.NodeStatus;
import hera.api.model.Peer;
import hera.api.model.PeerMetric;
import hera.api.model.RawTransaction;
import hera.api.model.ServerInfo;
import hera.api.model.StakeInfo;
import hera.api.model.StreamObserver;
import hera.api.model.Subscription;
import hera.api.model.Transaction;
import hera.api.model.TxHash;
import hera.exception.WalletException;
import hera.exception.WalletExceptionConverter;
import hera.key.AergoKey;
import hera.key.AergoSignVerifier;
import hera.keystore.JavaKeyStore;
import hera.util.ExceptionConverter;
import hera.wallet.Wallet;
import hera.wallet.WalletApi;
import java.io.FileOutputStream;
import java.security.KeyStore;
import java.util.List;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;

/**
 * Legacy wallet with poor interfaces. I hacked some apis of WalletApi to keep behaviors of legacy
 * wallet. Remove after removing account interface.
 *
 * @author taeiklim
 *
 */
<span class="fc" id="L67">@RequiredArgsConstructor</span>
public class LegacyWallet implements Wallet {

<span class="fc" id="L70">  protected final transient Logger logger = getLogger(getClass());</span>

<span class="fc" id="L72">  protected final ExceptionConverter&lt;WalletException&gt; exceptionConverter =</span>
      new WalletExceptionConverter();

  protected final WalletApi delegate;

  @Override
  public Account getAccount() {
<span class="nc" id="L79">    return new AccountFactory().create(delegate.getPrincipal(), delegate);</span>
  }

  @Override
  public AccountTotalVote getVotes() {
<span class="nc" id="L84">    return delegate.queryApi().getVotesOf(delegate.getPrincipal());</span>
  }

  @Override
  public long getRecentlyUsedNonce() {
<span class="nc" id="L89">    return getAccountState().getNonce();</span>
  }

  @Override
  public long incrementAndGetNonce() {
<span class="nc" id="L94">    return getAccountState().getNonce() + 1L;</span>
  }

  @Override
  public void bindKeyStore(KeyStore keyStore) {
<span class="nc" id="L99">    delegate.bind(keyStore);</span>
<span class="nc" id="L100">  }</span>

  @Override
  public void saveKey(AergoKey key, String password) {
<span class="nc" id="L104">    delegate.save(Authentication.of(key.getAddress(), password), key);</span>
<span class="nc" id="L105">  }</span>

  @Override
  public void saveKey(AergoKey key, Identity identity, String password) {
<span class="nc" id="L109">    delegate.save(Authentication.of(identity, password), key);</span>
<span class="nc" id="L110">  }</span>

  @Override
  public String exportKey(Authentication authentication) {
<span class="nc" id="L114">    return delegate.export(authentication);</span>
  }

  @Override
  public List&lt;Identity&gt; listKeyStoreIdentities() {
<span class="nc" id="L119">    return delegate.listIdentities();</span>
  }

  @Override
  public boolean unlock(Authentication authentication) {
<span class="nc" id="L124">    return delegate.unlock(authentication);</span>
  }

  @Override
  public boolean lock(Authentication authentication) {
<span class="nc" id="L129">    return delegate.lock(authentication);</span>
  }

  @Override
  public void storeKeyStore(String path, String password) {
    try {
<span class="nc" id="L135">      final WalletApiImpl walletApiImpl = (WalletApiImpl) delegate;</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">      if (walletApiImpl.keyStore instanceof JavaKeyStore) {</span>
<span class="nc" id="L137">        final KeyStore javaKeyStore = ((JavaKeyStore) walletApiImpl.keyStore).getJavaKeyStore();</span>
<span class="nc" id="L138">        javaKeyStore.store(new FileOutputStream(path), password.toCharArray());</span>
      }
<span class="nc" id="L140">    } catch (Exception e) {</span>
<span class="nc" id="L141">      throw new WalletException(e);</span>
<span class="nc" id="L142">    }</span>
<span class="nc" id="L143">  }</span>

  @Override
  public AccountState getAccountState() {
<span class="nc" id="L147">    return delegate.queryApi().getAccountState(delegate.getPrincipal());</span>
  }

  @Override
  public AccountState getAccountState(Account account) {
<span class="nc" id="L152">    return delegate.queryApi().getAccountState(account.getAddress());</span>
  }

  @Override
  public AccountState getAccountState(AccountAddress accountAddress) {
<span class="nc" id="L157">    return delegate.queryApi().getAccountState(accountAddress);</span>
  }

  @Override
  public AccountAddress getNameOwner(String name) {
<span class="nc" id="L162">    return delegate.queryApi().getNameOwner(name);</span>
  }

  @Override
  public AccountAddress getNameOwner(String name, long blockNumber) {
<span class="nc" id="L167">    return delegate.queryApi().getNameOwner(name, blockNumber);</span>
  }

  @Override
  public StakeInfo getStakingInfo() {
<span class="nc" id="L172">    return delegate.queryApi().getStakingInfo(delegate.getPrincipal());</span>
  }

  @Override
  public StakeInfo getStakingInfo(Account account) {
<span class="nc" id="L177">    return delegate.queryApi().getStakingInfo(account.getAddress());</span>
  }

  @Override
  public StakeInfo getStakingInfo(AccountAddress accountAddress) {
<span class="nc" id="L182">    return delegate.queryApi().getStakingInfo(accountAddress);</span>
  }

  @Override
  public List&lt;ElectedCandidate&gt; listElectedBps(int showCount) {
<span class="nc" id="L187">    return delegate.queryApi().listElectedBps(showCount);</span>
  }

  @Override
  public List&lt;ElectedCandidate&gt; listElected(String voteId, int showCount) {
<span class="nc" id="L192">    return delegate.queryApi().listElected(voteId, showCount);</span>
  }

  @Override
  public AccountTotalVote getVotesOf(Account account) {
<span class="nc" id="L197">    return delegate.queryApi().getVotesOf(account.getAddress());</span>
  }

  @Override
  public AccountTotalVote getVotesOf(AccountAddress accountAddress) {
<span class="nc" id="L202">    return delegate.queryApi().getVotesOf(accountAddress);</span>
  }

  @Override
  public List&lt;AccountAddress&gt; listServerKeyStoreAccounts() {
<span class="nc" id="L207">    return delegate.queryApi().listServerKeyStoreAccounts();</span>
  }

  @Override
  public BlockHash getBestBlockHash() {
<span class="nc" id="L212">    return delegate.queryApi().getBestBlockHash();</span>
  }

  @Override
  public long getBestBlockHeight() {
<span class="nc" id="L217">    return delegate.queryApi().getBestBlockHeight();</span>
  }

  @Override
  public ChainIdHash getChainIdHash() {
<span class="nc" id="L222">    return delegate.queryApi().getChainIdHash();</span>
  }

  @Override
  public BlockchainStatus getBlockchainStatus() {
<span class="nc" id="L227">    return delegate.queryApi().getBlockchainStatus();</span>
  }

  @Override
  public ChainInfo getChainInfo() {
<span class="nc" id="L232">    return delegate.queryApi().getChainInfo();</span>
  }

  @Override
  public ChainStats getChainStats() {
<span class="nc" id="L237">    return delegate.queryApi().getChainStats();</span>
  }

  @Override
  public List&lt;Peer&gt; listNodePeers() {
<span class="nc" id="L242">    return delegate.queryApi().listNodePeers();</span>
  }

  @Override
  public List&lt;PeerMetric&gt; listPeerMetrics() {
<span class="nc" id="L247">    return delegate.queryApi().listPeerMetrics();</span>
  }

  @Override
  public ServerInfo getServerInfo(List&lt;String&gt; categories) {
<span class="nc" id="L252">    return delegate.queryApi().getServerInfo(categories);</span>
  }

  @Override
  public NodeStatus getNodeStatus() {
<span class="nc" id="L257">    return delegate.queryApi().getNodeStatus();</span>
  }

  @Override
  public BlockMetadata getBlockMetadata(BlockHash blockHash) {
<span class="nc" id="L262">    return delegate.queryApi().getBlockMetadata(blockHash);</span>
  }

  @Override
  public BlockMetadata getBlockMetadata(long height) {
<span class="nc" id="L267">    return delegate.queryApi().getBlockMetadata(height);</span>
  }

  @Override
  public List&lt;BlockMetadata&gt; listBlockMetadatas(BlockHash blockHash, int size) {
<span class="nc" id="L272">    return delegate.queryApi().listBlockMetadatas(blockHash, size);</span>
  }

  @Override
  public List&lt;BlockMetadata&gt; listBlockMetadatas(long height, int size) {
<span class="nc" id="L277">    return delegate.queryApi().listBlockMetadatas(height, size);</span>
  }

  @Override
  public Block getBlock(BlockHash blockHash) {
<span class="nc" id="L282">    return delegate.queryApi().getBlock(blockHash);</span>
  }

  @Override
  public Block getBlock(long height) {
<span class="nc" id="L287">    return delegate.queryApi().getBlock(height);</span>
  }

  @Override
  public Subscription&lt;BlockMetadata&gt; subscribeNewBlockMetadata(
      StreamObserver&lt;BlockMetadata&gt; observer) {
<span class="nc" id="L293">    return delegate.queryApi().subscribeNewBlockMetadata(observer);</span>
  }

  @Override
  public Subscription&lt;Block&gt; subscribeNewBlock(StreamObserver&lt;Block&gt; observer) {
<span class="nc" id="L298">    return delegate.queryApi().subscribeNewBlock(observer);</span>
  }

  @Override
  public Transaction getTransaction(TxHash txHash) {
<span class="nc" id="L303">    return delegate.queryApi().getTransaction(txHash);</span>
  }

  @Override
  public ContractTxReceipt getReceipt(ContractTxHash contractTxHash) {
<span class="nc" id="L308">    return delegate.queryApi().getReceipt(contractTxHash);</span>
  }

  @Override
  public ContractInterface getContractInterface(ContractAddress contractAddress) {
<span class="nc" id="L313">    return delegate.queryApi().getContractInterface(contractAddress);</span>
  }

  @Override
  public ContractResult query(ContractInvocation contractInvocation) {
<span class="nc" id="L318">    return delegate.queryApi().query(contractInvocation);</span>
  }

  @Override
  public List&lt;Event&gt; listEvents(EventFilter filter) {
<span class="nc" id="L323">    return delegate.queryApi().listEvents(filter);</span>
  }

  @Override
  public Subscription&lt;Event&gt; subscribeEvent(EventFilter filter, StreamObserver&lt;Event&gt; observer) {
<span class="nc" id="L328">    return delegate.queryApi().subscribeEvent(filter, observer);</span>
  }

  @Override
  public ChainIdHash getCachedChainIdHash() {
<span class="nc" id="L333">    final WalletApiImpl walletApiImpl = (WalletApiImpl) delegate;</span>
<span class="nc" id="L334">    QueryApiImpl queryApiImpl = (QueryApiImpl) walletApiImpl.queryApi;</span>
<span class="nc" id="L335">    return queryApiImpl.client.getCachedChainIdHash();</span>
  }

  @Override
  public void cacheChainIdHash() {
<span class="nc" id="L340">    final WalletApiImpl walletApiImpl = (WalletApiImpl) delegate;</span>
<span class="nc" id="L341">    QueryApiImpl queryApiImpl = (QueryApiImpl) walletApiImpl.queryApi;</span>
<span class="nc" id="L342">    queryApiImpl.client.cacheChainIdHash(getChainIdHash());</span>
<span class="nc" id="L343">  }</span>

  @Override
  public void cacheChainIdHash(ChainIdHash chainIdHash) {
<span class="nc" id="L347">    final WalletApiImpl walletApiImpl = (WalletApiImpl) delegate;</span>
<span class="nc" id="L348">    QueryApiImpl queryApiImpl = (QueryApiImpl) walletApiImpl.queryApi;</span>
<span class="nc" id="L349">    queryApiImpl.client.cacheChainIdHash(chainIdHash);</span>
<span class="nc" id="L350">  }</span>

  @Override
  public Account loadAccount(Authentication authentication) {
<span class="nc" id="L354">    unlock(authentication);</span>
<span class="nc" id="L355">    return getAccount();</span>
  }

  @Override
  public Transaction sign(RawTransaction rawTransaction) {
<span class="nc" id="L360">    return delegate.sign(rawTransaction);</span>
  }

  @Override
  public boolean verify(Transaction transaction) {
    try {
<span class="nc" id="L366">      logger.debug(&quot;Verify signed transaction {}&quot;, transaction);</span>
<span class="nc" id="L367">      final AergoSignVerifier verifier = new AergoSignVerifier();</span>
<span class="nc" id="L368">      return verifier.verify(transaction);</span>
<span class="nc" id="L369">    } catch (Exception e) {</span>
<span class="nc" id="L370">      throw exceptionConverter.convert(e);</span>
    }
  }

  @Override
  public TxHash createName(String name) {
<span class="nc" id="L376">    return delegate.transactionApi().createName(name);</span>
  }

  @Override
  public TxHash updateName(String name, AccountAddress newOwner) {
<span class="nc" id="L381">    return delegate.transactionApi().updateName(name, newOwner);</span>
  }

  @Override
  public TxHash stake(Aer amount) {
<span class="nc" id="L386">    return delegate.transactionApi().stake(amount);</span>
  }

  @Override
  public TxHash unstake(Aer amount) {
<span class="nc" id="L391">    return delegate.transactionApi().stake(amount);</span>
  }

  @Override
  public TxHash voteBp(List&lt;String&gt; candidates) {
<span class="nc" id="L396">    return delegate.transactionApi().voteBp(candidates);</span>
  }

  @Override
  public TxHash vote(String voteId, List&lt;String&gt; candidates) {
<span class="nc" id="L401">    return delegate.transactionApi().vote(voteId, candidates);</span>
  }

  @Override
  public TxHash send(String recipient, Aer amount) {
<span class="nc" id="L406">    return delegate.transactionApi().send(recipient, amount, Fee.ZERO);</span>
  }

  @Override
  public TxHash send(String recipient, Aer amount, Fee fee) {
<span class="nc" id="L411">    return delegate.transactionApi().send(recipient, amount, fee);</span>
  }

  @Override
  public TxHash send(String recipient, Aer amount, BytesValue payload) {
<span class="nc" id="L416">    return delegate.transactionApi().send(recipient, amount, Fee.ZERO, payload);</span>
  }

  @Override
  public TxHash send(String recipient, Aer amount, Fee fee, BytesValue payload) {
<span class="nc" id="L421">    return delegate.transactionApi().send(recipient, amount, fee, payload);</span>
  }

  @Override
  public TxHash send(AccountAddress recipient, Aer amount) {
<span class="nc" id="L426">    return delegate.transactionApi().send(recipient, amount, Fee.ZERO);</span>
  }

  @Override
  public TxHash send(AccountAddress recipient, Aer amount, Fee fee) {
<span class="nc" id="L431">    return delegate.transactionApi().send(recipient, amount, fee);</span>
  }

  @Override
  public TxHash send(AccountAddress recipient, Aer amount, BytesValue payload) {
<span class="nc" id="L436">    return delegate.transactionApi().send(recipient, amount, Fee.ZERO, payload);</span>
  }

  @Override
  public TxHash send(AccountAddress recipient, Aer amount, Fee fee, BytesValue payload) {
<span class="nc" id="L441">    return delegate.transactionApi().send(recipient, amount, fee, payload);</span>
  }

  @Override
  public TxHash commit(RawTransaction rawTransaction) {
<span class="nc" id="L446">    return delegate.transactionApi().commit(rawTransaction);</span>
  }

  @Override
  public TxHash commit(Transaction signedTransaction) {
<span class="nc" id="L451">    return delegate.transactionApi().commit(signedTransaction);</span>
  }

  @Override
  public ContractTxHash deploy(ContractDefinition contractDefinition) {
<span class="nc" id="L456">    return delegate.transactionApi().deploy(contractDefinition, Fee.ZERO);</span>
  }

  @Override
  public ContractTxHash deploy(ContractDefinition contractDefinition, Fee fee) {
<span class="nc" id="L461">    return delegate.transactionApi().deploy(contractDefinition, fee);</span>
  }

  @Override
  public ContractTxHash execute(ContractInvocation contractInvocation) {
<span class="nc" id="L466">    return delegate.transactionApi().execute(contractInvocation, Fee.ZERO);</span>
  }

  @Override
  public ContractTxHash execute(ContractInvocation contractInvocation, Fee fee) {
<span class="nc" id="L471">    return delegate.transactionApi().execute(contractInvocation, fee);</span>
  }

  @Override
  public void close() {
<span class="nc" id="L476">    final WalletApiImpl walletApiImpl = (WalletApiImpl) delegate;</span>
<span class="nc" id="L477">    QueryApiImpl queryApiImpl = (QueryApiImpl) walletApiImpl.queryApi;</span>
<span class="nc" id="L478">    queryApiImpl.client.close();</span>
<span class="nc" id="L479">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>