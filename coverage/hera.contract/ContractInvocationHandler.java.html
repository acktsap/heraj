<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContractInvocationHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">heraj</a> &gt; <a href="index.source.html" class="el_package">hera.contract</a> &gt; <span class="el_source">ContractInvocationHandler.java</span></div><h1>ContractInvocationHandler.java</h1><pre class="source lang-java linenums">package hera.contract;

import static org.slf4j.LoggerFactory.getLogger;

import hera.annotation.ApiAudience;
import hera.annotation.ApiStability;
import hera.api.model.ContractAddress;
import hera.api.model.ContractFunction;
import hera.api.model.ContractInterface;
import hera.api.model.ContractInvocation;
import hera.api.model.ContractResult;
import hera.api.model.Fee;
import hera.exception.ContractException;
import hera.util.StringUtils;
import hera.wallet.Wallet;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.Setter;
import org.slf4j.Logger;

@ApiAudience.Private
@ApiStability.Unstable
public class ContractInvocationHandler implements InvocationHandler {

<span class="fc" id="L27">  protected final Logger logger = getLogger(getClass());</span>

<span class="fc" id="L29">  @Getter(value = AccessLevel.PROTECTED)</span>
  protected ContractAddress contractAddress;

<span class="fc" id="L32">  @Getter(value = AccessLevel.PROTECTED)</span>
  protected ContractInterface contractInterface;

<span class="fc" id="L35">  @Setter</span>
  protected Wallet wallet;

<span class="fc" id="L38">  @Getter(value = AccessLevel.PROTECTED)</span>
<span class="fc" id="L39">  @Setter</span>
<span class="fc" id="L40">  protected Fee fee = Fee.getDefaultFee();</span>

<span class="fc" id="L42">  ContractInvocationHandler(final ContractAddress contractAddress) {</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">    if (null == contractAddress) {</span>
<span class="fc" id="L44">      throw new ContractException(&quot;Contract address must not null&quot;);</span>
    }
<span class="fc" id="L46">    this.contractAddress = contractAddress;</span>
<span class="fc" id="L47">  }</span>

  protected Wallet getWallet() {
<span class="fc bfc" id="L50" title="All 2 branches covered.">    if (null == this.wallet) {</span>
<span class="fc" id="L51">      throw new ContractException(&quot;No binded wallet&quot;);</span>
    }
<span class="fc" id="L53">    return this.wallet;</span>
  }

  @Override
  public Object invoke(final Object proxy, final Method method, final Object[] args)
      throws Throwable {
    try {
<span class="fc" id="L60">      logger.debug(&quot;Method: {}&quot;, method);</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">      if (!method.getDeclaringClass().isInterface()) {</span>
<span class="fc" id="L62">        return method.invoke(this, args);</span>
      }

<span class="fc bfc" id="L65" title="All 2 branches covered.">      logger.debug(&quot;Proxy: {}, Method: {}, Args: {}, Ret: {}&quot;, proxy, method,</span>
<span class="fc" id="L66">          (args == null) ? null : StringUtils.join(args, &quot;,&quot;));</span>

<span class="fc bfc" id="L68" title="All 2 branches covered.">      if (isContractConfig(method)) {</span>
<span class="fc" id="L69">        logger.debug(&quot;Invocation is contract config: {}&quot;, method);</span>
<span class="fc" id="L70">        invokeConfigMethod(proxy, method, args);</span>
<span class="fc" id="L71">        return null;</span>
      } else {
<span class="fc" id="L73">        logger.debug(&quot;Invocation is contract call: {}&quot;, method);</span>
<span class="fc" id="L74">        return invokeUserMethod(proxy, method, args);</span>
      }
<span class="nc" id="L76">    } catch (Exception e) {</span>
<span class="nc" id="L77">      throw new ContractException(e);</span>
    }
  }

  protected boolean isContractConfig(final Method method) {
<span class="fc" id="L82">    return &quot;bind&quot;.equals(method.getName());</span>
  }

  protected void invokeConfigMethod(final Object proxy, final Method method, final Object[] args) {
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">    if (args.length &gt; 1) {</span>
<span class="nc" id="L87">      throw new ContractException(&quot;Illegal number of arguments for method \'bind\'&quot;);</span>
    }

<span class="fc" id="L90">    final Object arg = args[0];</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">    if (arg instanceof Wallet) {</span>
<span class="fc" id="L92">      setWallet((Wallet) arg);</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">    } else if (arg instanceof Fee) {</span>
<span class="fc" id="L94">      setFee((Fee) arg);</span>
    } else {
<span class="nc" id="L96">      throw new ContractException(</span>
<span class="nc" id="L97">          &quot;Unable to process bind argument for type &quot; + arg.getClass().getName());</span>
    }
<span class="fc" id="L99">  }</span>

  protected Object invokeUserMethod(final Object proxy, final Method method, final Object[] args)
      throws Exception {
<span class="fc" id="L103">    final Wallet wallet = getWallet();</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">    if (null == getContractInterface()) {</span>
<span class="fc" id="L105">      final ContractInterface contractInterface = wallet.getContractInterface(getContractAddress());</span>
<span class="fc" id="L106">      validateInterface(proxy, contractInterface);</span>
<span class="fc" id="L107">      this.contractInterface = contractInterface;</span>
    }

<span class="fc" id="L110">    final ContractInterface contractInterface = getContractInterface();</span>
<span class="fc" id="L111">    final ContractInvocation contractInvocation = contractInterface.newInvocationBuilder()</span>
<span class="fc" id="L112">        .function(method.getName())</span>
<span class="fc" id="L113">        .args(args)</span>
<span class="fc" id="L114">        .build();</span>

<span class="fc bfc" id="L116" title="All 2 branches covered.">    if (Void.TYPE.equals(method.getReturnType())) {</span>
<span class="fc" id="L117">      logger.debug(&quot;Contract execution: {}&quot;, contractInvocation);</span>
<span class="fc" id="L118">      wallet.execute(contractInvocation, getFee());</span>
<span class="fc" id="L119">      return null;</span>
    } else {
<span class="fc" id="L121">      logger.debug(&quot;Contract query: {}&quot;, contractInvocation);</span>
<span class="fc" id="L122">      ContractResult result = wallet.query(contractInvocation);</span>
<span class="fc" id="L123">      return result.bind(method.getReturnType());</span>
    }
  }

  protected void validateInterface(final Object proxy, final ContractInterface contractInterface) {
<span class="fc" id="L128">    logger.debug(&quot;Validate {} with {}&quot;, proxy, contractInterface);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">    for (final Method method : proxy.getClass().getDeclaredMethods()) {</span>
<span class="fc bfc" id="L130" title="All 4 branches covered.">      if (isJavaObjectMethod(method) || isContractSpecificMethod(method)) {</span>
<span class="fc" id="L131">        continue;</span>
      }
      // check method name
<span class="fc" id="L134">      final String methodName = method.getName();</span>
<span class="fc" id="L135">      final ContractFunction contractFunction = contractInterface.findFunction(methodName);</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">      if (null == contractFunction) {</span>
<span class="nc" id="L137">        throw new ContractException(&quot;No method &quot; + methodName + &quot; in contract interface&quot;);</span>
      }
      // check method parameter count
<span class="fc" id="L140">      final int methodParameterCount = method.getParameterTypes().length;</span>
<span class="fc" id="L141">      final int actualArgCount = contractFunction.getArgumentNames().size();</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">      if (methodParameterCount != actualArgCount) {</span>
<span class="nc" id="L143">        throw new ContractException(String.format(</span>
<span class="nc" id="L144">            &quot;Method parameter count for %s is invalid (expected: %d)&quot;, methodName, actualArgCount));</span>
      }
    }
<span class="fc" id="L147">  }</span>

  protected boolean isJavaObjectMethod(final Method method) {
<span class="fc" id="L150">    final String methodName = method.getName();</span>
<span class="fc bfc" id="L151" title="All 4 branches covered.">    return &quot;equals&quot;.equals(methodName) || &quot;toString&quot;.equals(methodName)</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">        || &quot;hashCode&quot;.equals(methodName);</span>
  }

  protected boolean isContractSpecificMethod(final Method method) {
<span class="fc" id="L156">    final String name = method.getName();</span>
<span class="fc" id="L157">    final int parameterCount = method.getParameterTypes().length;</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">    for (final Method preDefinedMethod : SmartContract.class.getMethods()) {</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">      if (name.equals(preDefinedMethod.getName())</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">          &amp;&amp; parameterCount == preDefinedMethod.getParameterTypes().length) {</span>
<span class="fc" id="L161">        return true;</span>
      }
    }
<span class="fc" id="L164">    return false;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>